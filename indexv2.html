<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>ZEN BUILDS — Precision Under Pressure</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;500;700&family=Bebas+Neue&display=swap');
  :root {
    --bg: #0f0d0a; --accent: #f5c400; --accent2: #ff4d1c; --accent3: #00e5a0;
    --smalls-accent: #c084fc; --smalls-glow: rgba(192,132,252,0.35);
    --text: #e8e0c8; --dim: #6a6458; --panel: #1a1710;
    --panel-border: rgba(245,196,0,0.2); --danger: #ff4d1c; --ok: #00e5a0; --warn: #f5c400;
    --cardboard-light: #d4956a; --cardboard-mid: #b8743e; --cardboard-dark: #8c5228;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html { touch-action: none; overscroll-behavior: none; }
  body {
    background: var(--bg);
    background-image:
      radial-gradient(circle at 1px 1px, rgba(245,196,0,0.06) 1px, transparent 0);
    background-size: 20px 20px;
    color: var(--text); font-family: 'Rajdhani', sans-serif;
    height: 100dvh; overflow: hidden; display: flex; flex-direction: column;
    align-items: center; user-select: none; -webkit-user-select: none;
    touch-action: none; overscroll-behavior: none;
  }

  #header { width: 100%; max-width: 520px; display: flex; align-items: center;
    justify-content: space-between; padding: 5px 10px 2px; flex-shrink: 0; }
  .logo { font-family: 'Bebas Neue', cursive; font-size: 19px; letter-spacing: 3px;
    color: var(--accent); text-shadow: 0 0 20px rgba(245,196,0,0.4); line-height: 1; }
  .logo span { color: var(--dim); font-size: 8px; letter-spacing: 2px; display: block; font-family: 'Share Tech Mono', monospace; }
  #stats-bar { display: flex; gap: 4px; }
  .stat-chip { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 3px; padding: 2px 5px; text-align: center; }
  .stat-chip .val { font-family: 'Share Tech Mono', monospace; font-size: 11px; color: var(--accent); display: block; line-height: 1; }
  .stat-chip .lbl { font-size: 6px; letter-spacing: 1.5px; color: var(--dim); text-transform: uppercase; display: block; }
  .stat-chip.support .val { color: #60a5fa; }

  #main { display: flex; flex-direction: column; align-items: center; width: 100%;
    max-width: 520px; flex: 1; overflow: hidden; padding: 0 6px; gap: 3px; }

  .status-row { width: 100%; display: flex; align-items: center; gap: 6px; padding: 0 2px; }
  .status-label { font-size: 8px; letter-spacing: 1.5px; color: var(--dim); white-space: nowrap; font-family: 'Share Tech Mono', monospace; }
  .bar-track { flex: 1; height: 5px; background: #1a1a14; border-radius: 2px; overflow: hidden; border: 1px solid rgba(245,196,0,0.12); }
  .bar-fill { height: 100%; width: 0%; border-radius: 2px; transition: width 0.3s; }
  #height-fill { background: linear-gradient(90deg, var(--accent3), var(--accent)); }
  #support-fill { background: linear-gradient(90deg, #1d4ed8, #60a5fa); }
  .bar-val { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--accent); min-width: 32px; text-align: right; }
  #support-val { color: #60a5fa; }
  #cog-track { flex: 1; height: 5px; background: #1a1a14; border-radius: 2px; border: 1px solid rgba(245,196,0,0.12); position: relative; }
  #cog-fill { position: absolute; height: 100%; background: linear-gradient(90deg, var(--ok), var(--warn), var(--danger)); border-radius: 2px; left: 20%; width: 60%; }
  #cog-center-mark { position: absolute; top: -2px; width: 2px; height: 9px; background: var(--accent); left: 50%; transform: translateX(-50%); }
  #cog-marker { position: absolute; top: -3px; width: 4px; height: 11px; background: white; border-radius: 1px; transition: left 0.25s; transform: translateX(-50%); left: 50%; }
  #cog-status { font-family: 'Share Tech Mono', monospace; font-size: 8px; min-width: 44px; text-align: right; }

  #trailer-wrap { width: 100%; position: relative; flex: 1; min-height: 0; }
  #trailer-canvas { width: 100%; height: 100%; display: block; cursor: crosshair; }
  #placement-canvas { position: absolute; top:0;left:0;width:100%;height:100%;pointer-events:none; }
  #heatmap-canvas { position: absolute; top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0;transition:opacity 0.5s; }
  #heatmap-canvas.visible { opacity: 0.65; }

  #controls-area { width: 100%; display: flex; flex-direction: column; gap: 3px; flex-shrink: 0; padding-bottom: 5px; }

  .conveyor-header { display: flex; align-items: center; gap: 6px; padding: 0 2px; }
  .conveyor-label { font-family: 'Share Tech Mono', monospace; font-size: 8px; letter-spacing: 2px; text-transform: uppercase; white-space: nowrap; }
  .conveyor-label.main { color: var(--accent); }
  .conveyor-label.smalls { color: var(--smalls-accent); }
  .roller-track { flex: 1; height: 3px; background: #1a1a14; border-radius: 2px; overflow: hidden; }
  .roller-fill { height: 100%; width: 100%; background: repeating-linear-gradient(90deg, transparent, transparent 4px, currentColor 4px, currentColor 5px); animation: roller-scroll 0.55s linear infinite; }
  .roller-fill.main { color: rgba(245,196,0,0.45); }
  .roller-fill.smalls { color: rgba(192,132,252,0.45); }
  @keyframes roller-scroll { from{transform:translateX(0);} to{transform:translateX(-9px);} }

  .queue-row { display: flex; gap: 4px; justify-content: center; align-items: flex-end; }

  /* Queue slots with cardboard vibe */
  .queue-slot { flex: 1; max-width: 80px; height: 56px; border: 1px solid rgba(180,120,60,0.25);
    border-radius: 3px; display: flex; flex-direction: column; align-items: center;
    justify-content: center; cursor: pointer; transition: border-color 0.12s, transform 0.1s;
    background: rgba(180,120,60,0.06); position: relative; overflow: hidden; }
  .queue-slot.selected { border-color: var(--accent); transform: translateY(-3px); background: rgba(245,196,0,0.08); }
  .queue-slot.expiring { border-color: rgba(255,77,28,0.6); animation: expiring-pulse 0.5s infinite; }
  @keyframes expiring-pulse { 0%,100%{background:rgba(255,77,28,0.05);} 50%{background:rgba(255,77,28,0.12);} }
  .queue-slot:hover:not(.selected):not(.expiring) { border-color: rgba(180,120,60,0.5); }
  .queue-slot.active-sel { border-color: var(--accent); box-shadow: 0 0 8px rgba(245,196,0,0.3); }

  .smalls-slot { flex: 1; max-width: 58px; height: 44px; border: 1px solid rgba(192,132,252,0.22);
    border-radius: 3px; display: flex; flex-direction: column; align-items: center;
    justify-content: center; cursor: pointer; transition: border-color 0.12s, transform 0.1s;
    background: rgba(192,132,252,0.04); position: relative; overflow: hidden; }
  .smalls-slot.selected { border-color: var(--smalls-accent); transform: translateY(-3px); background: rgba(192,132,252,0.11); box-shadow: 0 0 10px var(--smalls-glow); }
  .smalls-slot.expiring { border-color: rgba(255,77,28,0.5); animation: expiring-pulse 0.5s infinite; }
  .smalls-slot:hover:not(.selected):not(.expiring) { border-color: rgba(192,132,252,0.4); }
  .smalls-slot .box-dims { color: rgba(192,132,252,0.65) !important; }

  .box-visual { border-radius: 2px; display: flex; align-items: center; justify-content: center;
    font-family: 'Share Tech Mono', monospace; font-size: 5px; color: rgba(0,0,0,0.55); font-weight: bold;
    position: relative; overflow: hidden; }
  .box-dims { font-family: 'Share Tech Mono', monospace; font-size: 5px; color: var(--dim); margin-top: 1px; text-align: center; }
  .timer-bar { position: absolute; bottom: 0; left: 0; height: 2px; background: var(--accent); transition: width 0.1s linear; }
  .smalls-slot .timer-bar { background: var(--smalls-accent); }

  /* missed parcel counter */
  #missed-badge {
    font-family: 'Share Tech Mono', monospace; font-size: 7px; color: var(--accent2);
    background: rgba(255,77,28,0.1); border: 1px solid rgba(255,77,28,0.3);
    border-radius: 2px; padding: 1px 5px; white-space: nowrap;
  }

  #stash-row { display: flex; justify-content: space-between; align-items: center; gap: 5px; }
  .stash-slot { width: 52px; height: 48px; border: 1px dashed rgba(245,196,0,0.3); border-radius: 4px;
    display: flex; align-items: center; justify-content: center; font-size: 7px;
    color: var(--dim); letter-spacing: 1px; text-transform: uppercase; cursor: pointer;
    transition: border-color 0.2s; background: var(--panel); flex-direction: column; }
  .stash-slot:hover { border-color: var(--accent); }
  .stash-slot.has-box { border-style: solid; border-color: var(--accent2); }
  .stash-slot .stash-label { font-family: 'Share Tech Mono', monospace; font-size: 6px; color: var(--dim); margin-top: 2px; }
  #action-panel { display: flex; flex-direction: column; gap: 3px; align-items: center; }
  #rotate-btn { background: var(--panel); border: 1px solid var(--panel-border); color: var(--accent);
    font-family: 'Bebas Neue', cursive; letter-spacing: 2px; font-size: 14px; padding: 5px 16px;
    border-radius: 3px; cursor: pointer; transition: background 0.12s; }
  #rotate-btn:hover, #rotate-btn:active { background: rgba(245,196,0,0.1); border-color: var(--accent); }
  #action-hint { font-size: 7px; color: var(--dim); letter-spacing: 1px; text-transform: uppercase; font-family: 'Share Tech Mono', monospace; text-align: center; }

  .section-divider { width: 100%; display: flex; align-items: center; gap: 5px; padding: 0 2px; }
  .divider-line { flex: 1; height: 1px; background: rgba(192,132,252,0.14); }
  .divider-text { font-family: 'Share Tech Mono', monospace; font-size: 7px; color: var(--smalls-accent); letter-spacing: 2px; opacity: 0.8; white-space: nowrap; }

  #void-badge { display: none; font-family: 'Share Tech Mono', monospace; font-size: 7px;
    color: var(--smalls-accent); letter-spacing: 1px; background: rgba(192,132,252,0.1);
    border: 1px solid rgba(192,132,252,0.28); border-radius: 2px; padding: 1px 5px;
    animation: void-pulse 1.2s infinite; }
  #void-badge.visible { display: block; }
  @keyframes void-pulse { 0%,100%{opacity:1;} 50%{opacity:0.45;} }

  .overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center;
    justify-content: center; background: rgba(5,4,2,0.96); z-index: 100; padding: 20px; }
  .overlay.hidden { display: none; }
  .overlay-title { font-family: 'Bebas Neue', cursive; font-size: 48px; letter-spacing: 6px;
    color: var(--accent); text-shadow: 0 0 40px rgba(245,196,0,0.5); text-align: center; line-height: 0.9; }
  .overlay-sub { font-size: 10px; letter-spacing: 3px; color: var(--dim); text-transform: uppercase;
    margin: 8px 0 18px; font-family: 'Share Tech Mono', monospace; text-align: center; }
  .overlay-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 290px; margin-bottom: 18px; }
  .ov-stat { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 4px; padding: 8px 12px; }
  .ov-stat .v { font-family: 'Bebas Neue', cursive; font-size: 26px; color: var(--accent); letter-spacing: 2px; display: block; line-height: 1; }
  .ov-stat .l { font-size: 8px; color: var(--dim); letter-spacing: 1.5px; text-transform: uppercase; font-family: 'Share Tech Mono', monospace; }
  .btn-primary { background: var(--accent); color: #000; border: none; font-family: 'Bebas Neue', cursive;
    font-size: 18px; letter-spacing: 4px; padding: 10px 42px; border-radius: 3px; cursor: pointer;
    transition: transform 0.1s, box-shadow 0.2s; box-shadow: 0 0 28px rgba(245,196,0,0.3); }
  .btn-primary:hover { transform: scale(1.03); box-shadow: 0 0 48px rgba(245,196,0,0.5); }
  .btn-primary:active { transform: scale(0.97); }
  .diff-select { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; justify-content: center; }
  .diff-btn { background: var(--panel); border: 1px solid var(--panel-border); color: var(--text);
    font-family: 'Rajdhani', sans-serif; font-size: 12px; font-weight: 500; letter-spacing: 1px;
    padding: 6px 13px; border-radius: 3px; cursor: pointer; transition: all 0.13s; }
  .diff-btn.active { background: rgba(245,196,0,0.15); border-color: var(--accent); color: var(--accent); }
  #tip-text { font-size: 10px; color: var(--dim); text-align: center; max-width: 280px; line-height: 1.5;
    font-family: 'Share Tech Mono', monospace; margin-top: -8px; margin-bottom: 16px; }
  .tier-badge { display: inline-flex; align-items: center; gap: 5px; font-family: 'Share Tech Mono', monospace;
    font-size: 8px; letter-spacing: 1.5px; color: var(--dim); border: 1px solid rgba(245,196,0,0.14);
    border-radius: 2px; padding: 2px 8px; margin-top: 6px; text-align: center; }
  .tier-badge .dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); animation: pulse 1.5s infinite; flex-shrink: 0; }
  @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

  #instability-flash { position: fixed; inset: 0; background: rgba(255,77,28,0); pointer-events: none; z-index: 50; transition: background 0.1s; }
  #instability-flash.flash { background: rgba(255,77,28,0.17); }
  #smalls-flash { position: fixed; inset: 0; background: rgba(192,132,252,0); pointer-events: none; z-index: 49; transition: background 0.15s; }
  #smalls-flash.flash { background: rgba(192,132,252,0.09); }

  .score-pop { position: fixed; font-family: 'Bebas Neue', cursive; font-size: 19px;
    pointer-events: none; z-index: 60; animation: pop-up 1s ease-out forwards; letter-spacing: 2px; }
  .score-pop.main { color: var(--accent); text-shadow: 0 0 10px rgba(245,196,0,0.6); }
  .score-pop.smalls { color: var(--smalls-accent); text-shadow: 0 0 10px var(--smalls-glow); font-size: 15px; }
  .score-pop.miss { color: var(--accent2); font-size: 13px; }
  @keyframes pop-up { 0%{opacity:1;transform:translateY(0) scale(1);} 100%{opacity:0;transform:translateY(-46px) scale(1.3);} }
</style>
</head>
<body>
<div id="instability-flash"></div>
<div id="smalls-flash"></div>

<div id="header">
  <div class="logo">ZEN BUILDS<span>PRECISION UNDER PRESSURE · v3</span></div>
  <div id="stats-bar">
    <div class="stat-chip"><span class="val" id="score-val">0</span><span class="lbl">Score</span></div>
    <div class="stat-chip"><span class="val" id="pph-val">—</span><span class="lbl">PPH</span></div>
    <div class="stat-chip support"><span class="val" id="support-val">—</span><span class="lbl">Support</span></div>
    <div class="stat-chip"><span class="val" id="tier-val">T1</span><span class="lbl">Tier</span></div>
  </div>
</div>

<div id="main">
  <div class="status-row">
    <div class="status-label">HEIGHT</div>
    <div class="bar-track"><div class="bar-fill" id="height-fill"></div></div>
    <div class="bar-val" id="height-pct">0%</div>
  </div>
  <div class="status-row">
    <div class="status-label">SUPPORT</div>
    <div class="bar-track"><div class="bar-fill" id="support-fill"></div></div>
    <div class="bar-val" id="support-pct" style="color:#60a5fa">0%</div>
  </div>
  <div class="status-row">
    <div class="status-label">COG&nbsp;BALANCE</div>
    <div id="cog-track">
      <div id="cog-fill"></div>
      <div id="cog-center-mark"></div>
      <div id="cog-marker"></div>
    </div>
    <div id="cog-status" style="color:var(--ok)">STABLE</div>
  </div>

  <div id="trailer-wrap">
    <canvas id="trailer-canvas"></canvas>
    <canvas id="placement-canvas"></canvas>
    <canvas id="heatmap-canvas"></canvas>
  </div>

  <div id="controls-area">
    <div class="conveyor-header">
      <div class="conveyor-label main">▶ MAIN BELT</div>
      <div class="roller-track"><div class="roller-fill main"></div></div>
      <div id="missed-badge">MISSED: 0</div>
    </div>
    <div class="queue-row" id="queue-row"></div>

    <div class="section-divider">
      <div class="divider-line"></div>
      <div class="divider-text">◈ SMALLS BELT — GAP FILLERS</div>
      <div class="divider-line"></div>
    </div>
    <div class="conveyor-header">
      <div class="conveyor-label smalls">▶ SMALLS</div>
      <div class="roller-track"><div class="roller-fill smalls" style="animation-duration:0.38s"></div></div>
      <div id="void-badge">⬛ 0 VOIDS</div>
    </div>
    <div class="queue-row" id="smalls-row"></div>

    <div id="stash-row">
      <div class="stash-slot" id="stash-left" onclick="stashAction('left')">
        <span>STASH L</span><span class="stash-label">TAP</span>
      </div>
      <div id="action-panel">
        <button id="rotate-btn" onclick="rotateSelected()">↻ ROTATE</button>
        <div id="action-hint">SELECT → ROTATE → PLACE</div>
      </div>
      <div class="stash-slot" id="stash-right" onclick="stashAction('right')">
        <span>STASH R</span><span class="stash-label">TAP</span>
      </div>
    </div>
  </div>
</div>

<div class="overlay" id="start-overlay">
  <div class="overlay-title">ZEN<br>BUILDS</div>
  <div class="overlay-sub">Cardboard Wall Edition · v3</div>
  <div class="diff-select">
    <button class="diff-btn active" onclick="setDiff(1,this)">TIER 1</button>
    <button class="diff-btn" onclick="setDiff(2,this)">TIER 2</button>
    <button class="diff-btn" onclick="setDiff(3,this)">TIER 3</button>
    <button class="diff-btn" onclick="setDiff(4,this)">TIER 4</button>
  </div>
  <button class="btn-primary" onclick="startGame()">LOAD THE TRAILER</button>
  <div class="tier-badge"><div class="dot"></div><span>PLACE FREELY · SUPPORT SCORE IS YOUR MULTIPLIER · SMALLS FILL THE GAPS</span></div>
</div>

<div class="overlay hidden" id="gameover-overlay">
  <div class="overlay-title" id="go-title">GAME<br>OVER</div>
  <div class="overlay-sub" id="go-sub">NO VALID PLACEMENTS REMAIN</div>
  <div id="tip-text"></div>
  <div class="overlay-stat-grid">
    <div class="ov-stat"><span class="v" id="go-score">0</span><span class="l">Final Score</span></div>
    <div class="ov-stat"><span class="v" id="go-pph">0</span><span class="l">PPH</span></div>
    <div class="ov-stat"><span class="v" id="go-eff">0%</span><span class="l">Efficiency</span></div>
    <div class="ov-stat"><span class="v" id="go-support">0%</span><span class="l">Support</span></div>
  </div>
  <button class="btn-primary" onclick="restartGame()">RELOAD</button>
</div>

<script>
// ================================================================
// ZEN BUILDS v3 — CARDBOARD WALL EDITION
// Free placement (bounds + overlap only)
// Support score = cosmetic multiplier, not a gate
// Cardboard box rendering with tape + labels
// Background grid on trailer
// Conveyor never removes SELECTED piece — misses deduct from score
// ================================================================

const GRID_W=17, GRID_H=18, WIN_H=0.95;

// Cardboard color families — warm browns, tans, kraft tones
const CARDBOARD_PALETTES = [
  // Main pieces: kraft/tan/brown variants
  { base:'#c8955a', light:'#ddb07a', dark:'#9a6535', tape:'rgba(210,190,120,0.7)', label:'rgba(255,250,230,0.9)' },
  { base:'#b8834a', light:'#ce9e68', dark:'#8a5f28', tape:'rgba(200,175,100,0.7)', label:'rgba(255,248,220,0.9)' },
  { base:'#c4a060', light:'#d8b87c', dark:'#967840', tape:'rgba(215,195,130,0.7)', label:'rgba(255,252,235,0.9)' },
  { base:'#a87848', light:'#bf9260', dark:'#7c5428', tape:'rgba(195,170,105,0.7)', label:'rgba(250,245,220,0.9)' },
  { base:'#d09858', light:'#e4b272', dark:'#a07038', tape:'rgba(220,200,125,0.7)', label:'rgba(255,252,230,0.9)' },
  // Dense: darker, heavier-looking
  { base:'#7a5530', light:'#966848', dark:'#543018', tape:'rgba(170,140,80,0.7)', label:'rgba(240,230,200,0.9)' },
  { base:'#6e4e2c', light:'#886242', dark:'#4c3018', tape:'rgba(165,135,75,0.7)', label:'rgba(238,228,198,0.9)' },
  // Fragile: lighter, almost white-ish cardboard
  { base:'#e8d4a8', light:'#f4e6c0', dark:'#c4a868', tape:'rgba(230,215,160,0.8)', label:'rgba(255,255,245,0.95)' },
  { base:'#dcc898', light:'#eedcb0', dark:'#b89c58', tape:'rgba(225,208,150,0.8)', label:'rgba(255,254,244,0.95)' },
];

// Smalls: smaller parcel colours — slightly more varied, still realistic
const SMALLS_CARDBOARD = [
  { base:'#c09050', light:'#d4a868', dark:'#8c6430', tape:'rgba(200,180,110,0.75)', label:'rgba(255,250,228,0.9)' },
  { base:'#b07840', light:'#c69058', dark:'#805420', tape:'rgba(190,165,95,0.75)', label:'rgba(252,245,220,0.9)' },
  { base:'#d8a860', light:'#ecca7c', dark:'#a87c38', tape:'rgba(218,195,120,0.75)', label:'rgba(255,252,232,0.9)' },
  { base:'#a86840', light:'#be8058', dark:'#7c4820', tape:'rgba(185,155,88,0.75)', label:'rgba(248,240,215,0.9)' },
  { base:'#c8a848', light:'#dcbc62', dark:'#9c7c28', tape:'rgba(210,188,108,0.75)', label:'rgba(255,251,226,0.9)' },
  { base:'#e0c898', light:'#f0ddb2', dark:'#bc9c60', tape:'rgba(228,210,148,0.8)', label:'rgba(255,255,242,0.95)' },
];

// Label text pool — realistic box label snippets
const LABEL_TEXT = [
  'FRAGILE','THIS SIDE UP','HANDLE\nWITH CARE','HEAVY','DO NOT\nSTACK',
  'KEEP DRY','RUSH','PRIORITY','STD SHIP','RETURNS',
  'LOT A','LOT B','REF #','SKU','BATCH',
];

const MAIN_POOL={
  1:[
    {w:2,h:3,wc:2,sr:3,fr:0,type:'standard'},{w:3,h:2,wc:2,sr:3,fr:0,type:'standard'},
    {w:2,h:2,wc:1,sr:4,fr:0,type:'standard'},{w:4,h:2,wc:2,sr:3,fr:0,type:'standard'},
    {w:2,h:4,wc:3,sr:2,fr:0,type:'dense'},{w:3,h:3,wc:3,sr:3,fr:0,type:'standard'},
    {w:4,h:3,wc:2,sr:3,fr:0,type:'standard'},{w:5,h:2,wc:2,sr:3,fr:0,type:'standard'},
    {w:3,h:4,wc:3,sr:2,fr:0,type:'standard'},{w:6,h:2,wc:3,sr:3,fr:0,type:'standard'},
  ],
  2:[
    {w:2,h:3,wc:2,sr:3,fr:0,type:'standard'},{w:3,h:4,wc:3,sr:2,fr:0,type:'dense'},
    {w:1,h:3,wc:1,sr:5,fr:1,type:'fragile'},{w:4,h:3,wc:4,sr:2,fr:0,type:'dense'},
    {w:2,h:2,wc:2,sr:3,fr:0,type:'standard'},{w:5,h:2,wc:3,sr:3,fr:0,type:'standard'},
    {w:2,h:5,wc:4,sr:1,fr:0,type:'dense'},{w:3,h:1,wc:1,sr:4,fr:1,type:'fragile'},
    {w:4,h:4,wc:4,sr:2,fr:0,type:'dense'},{w:6,h:2,wc:3,sr:3,fr:0,type:'standard'},
    {w:3,h:5,wc:3,sr:2,fr:0,type:'standard'},{w:5,h:3,wc:4,sr:2,fr:0,type:'dense'},
  ],
  3:[
    {w:3,h:4,wc:4,sr:1,fr:0,type:'dense'},{w:1,h:4,wc:1,sr:5,fr:1,type:'fragile'},
    {w:2,h:3,wc:2,sr:3,fr:0,type:'standard'},{w:4,h:4,wc:5,sr:1,fr:0,type:'dense'},
    {w:3,h:2,wc:2,sr:4,fr:0,type:'standard'},{w:2,h:6,wc:5,sr:1,fr:0,type:'irregular'},
    {w:5,h:3,wc:4,sr:2,fr:0,type:'dense'},{w:3,h:3,wc:3,sr:3,fr:0,type:'standard'},
    {w:6,h:3,wc:4,sr:2,fr:0,type:'dense'},{w:4,h:5,wc:5,sr:1,fr:0,type:'irregular'},
    {w:2,h:4,wc:3,sr:2,fr:0,type:'standard'},{w:5,h:4,wc:5,sr:1,fr:0,type:'dense'},
  ],
  4:[
    {w:3,h:5,wc:5,sr:1,fr:0,type:'dense'},{w:1,h:5,wc:1,sr:5,fr:1,type:'fragile'},
    {w:2,h:4,wc:3,sr:2,fr:0,type:'standard'},{w:4,h:3,wc:5,sr:1,fr:0,type:'dense'},
    {w:3,h:6,wc:5,sr:1,fr:0,type:'irregular'},{w:5,h:4,wc:5,sr:1,fr:0,type:'dense'},
    {w:1,h:3,wc:1,sr:5,fr:1,type:'fragile'},{w:2,h:5,wc:4,sr:1,fr:0,type:'irregular'},
    {w:4,h:2,wc:3,sr:3,fr:0,type:'standard'},{w:6,h:4,wc:5,sr:1,fr:0,type:'dense'},
    {w:5,h:5,wc:5,sr:1,fr:0,type:'irregular'},{w:3,h:4,wc:4,sr:1,fr:0,type:'dense'},
  ]
};

const SMALLS_POOL=[
  {w:1,h:1,wc:1,sr:4,fr:0,type:'standard',n:'CUBE'},
  {w:2,h:1,wc:1,sr:4,fr:0,type:'standard',n:'CAP'},
  {w:1,h:2,wc:1,sr:4,fr:0,type:'standard',n:'SLIM'},
  {w:3,h:1,wc:1,sr:4,fr:0,type:'standard',n:'SHELF'},
  {w:1,h:3,wc:1,sr:5,fr:1,type:'fragile',n:'POST'},
  {w:2,h:2,wc:1,sr:4,fr:0,type:'standard',n:'TILE'},
  {w:4,h:1,wc:2,sr:3,fr:0,type:'standard',n:'PLANK'},
  {w:1,h:4,wc:1,sr:5,fr:1,type:'fragile',n:'RAIL'},
  {w:2,h:1,wc:3,sr:3,fr:0,type:'dense',n:'PUCK'},
  {w:3,h:2,wc:2,sr:3,fr:0,type:'standard',n:'BRICK'},
  {w:2,h:3,wc:2,sr:3,fr:0,type:'standard',n:'BLOCK'},
  {w:1,h:2,wc:2,sr:4,fr:0,type:'dense',n:'SLUG'},
  {w:5,h:1,wc:1,sr:4,fr:0,type:'standard',n:'STRIP'},
  {w:1,h:5,wc:1,sr:5,fr:1,type:'fragile',n:'PILLAR'},
  {w:2,h:2,wc:3,sr:2,fr:0,type:'dense',n:'INGOT'},
  {w:3,h:1,wc:3,sr:3,fr:0,type:'dense',n:'BAR'},
  {w:4,h:2,wc:2,sr:3,fr:0,type:'standard',n:'PALLET'},
  {w:2,h:4,wc:2,sr:2,fr:0,type:'standard',n:'COLUMN'},
  {w:1,h:1,wc:3,sr:3,fr:0,type:'dense',n:'PEG'},
  {w:6,h:1,wc:2,sr:3,fr:0,type:'standard',n:'BOARD'},
  {w:1,h:6,wc:1,sr:5,fr:1,type:'fragile',n:'MAST'},
  {w:2,h:1,wc:1,sr:5,fr:1,type:'fragile',n:'GLASS'},
  {w:1,h:2,wc:1,sr:5,fr:1,type:'fragile',n:'VASE'},
  {w:3,h:2,wc:4,sr:2,fr:0,type:'dense',n:'ANVIL'},
  {w:4,h:1,wc:1,sr:5,fr:1,type:'fragile',n:'TRAY'},
  {w:1,h:4,wc:3,sr:3,fr:0,type:'dense',n:'SPIKE'},
  {w:5,h:1,wc:3,sr:3,fr:0,type:'dense',n:'SLAB'},
  {w:2,h:2,wc:2,sr:4,fr:0,type:'standard',n:'CRATE'},
];

const DROP_RATES={1:9000,2:8000,3:6500,4:5000};
const SMALLS_RATE=13000;
const MAIN_SZ=5, SMALLS_SZ=6;
const MISS_PENALTY=25; // score deducted per missed (non-selected) parcel

let state={}, selMain=null, selSmalls=null, selRot=false;
let animFrame=null, dropTimer=null, smallsTimer=null, startTime=null, placedCount=0, initDiff=1, hoverCell=null;

const tC=document.getElementById('trailer-canvas'),tCtx=tC.getContext('2d');
const pC=document.getElementById('placement-canvas'),pCtx=pC.getContext('2d');
const hC=document.getElementById('heatmap-canvas'),hCtx=hC.getContext('2d');
let CW,CH,cW,cH,tL,tT,tW,tH;

function resize(){
  const r=document.getElementById('trailer-wrap').getBoundingClientRect();
  CW=r.width;CH=r.height;
  tC.width=pC.width=hC.width=CW; tC.height=pC.height=hC.height=CH;
  tL=CW*.05; tT=CH*.02; tW=CW*.9; tH=CH*.95;
  cW=tW/GRID_W; cH=tH/GRID_H;
}

const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick=a=>a[rnd(0,a.length-1)];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

// Seeded random for per-box decoration (deterministic from box id)
function seededRand(seed) {
  let s = seed;
  return function() {
    s = (s * 9301 + 49297) % 233280;
    return s / 233280;
  };
}

function pickPalette(box, isSmall) {
  if(isSmall) return SMALLS_CARDBOARD[rnd(0, SMALLS_CARDBOARD.length-1)];
  if(box.type === 'fragile') return CARDBOARD_PALETTES[7 + (Math.random() > 0.5 ? 0 : 1)];
  if(box.type === 'dense') return CARDBOARD_PALETTES[5 + (Math.random() > 0.5 ? 0 : 1)];
  return CARDBOARD_PALETTES[rnd(0,4)];
}

function genMain(tier){
  const t={...pick(MAIN_POOL[tier])};
  const palette=pickPalette(t,false);
  const seed=rnd(1000,9999);
  return{...t,id:'M'+Date.now()+Math.random().toString(36).slice(2,4),
    palette,seed,timerPct:1,isSmall:false,
    label:pick(LABEL_TEXT)};
}
function genSmall(){
  const t={...pick(SMALLS_POOL)};
  const palette=pickPalette(t,true);
  const seed=rnd(1000,9999);
  return{...t,id:'S'+Date.now()+Math.random().toString(36).slice(2,4),
    palette,seed,timerPct:1,isSmall:true};
}
function dims(box,rot){
  if(rot&&box.type!=='irregular')return{w:box.h,h:box.w};
  return{w:box.w,h:box.h};
}

// ---- FREE PLACEMENT — bounds + overlap only ----
function legal(grid,box,gx,gy,rot){
  const{w,h}=dims(box,rot);
  if(gx<0||gy<0||gx+w>GRID_W||gy+h>GRID_H)return false;
  for(let dy=0;dy<h;dy++)for(let dx=0;dx<w;dx++)if(grid[gy+dy][gx+dx])return false;
  return true;
}

function anyLegal(grid,box){
  for(let y=0;y<GRID_H;y++)for(let x=0;x<GRID_W;x++)if(legal(grid,box,x,y,false)||legal(grid,box,x,y,true))return true;
  return false;
}

// ---- SUPPORT SCORE — cosmetic multiplier ----
// Returns 0.0–1.0: fraction of placed cells that are fully supported from below
function calcSupportScore(grid){
  let total=0,supported=0;
  const seen=new Set();
  for(let y=0;y<GRID_H;y++){
    for(let x=0;x<GRID_W;x++){
      const c=grid[y][x];
      if(!c)continue;
      total++;
      const belowY=y+1;
      if(belowY===GRID_H){supported++;continue;} // on floor
      if(grid[belowY][x])supported++;
    }
  }
  return total===0?1:supported/total;
}

// Support multiplier: 1.0x at 100% support, 0.5x at 0% support
function supportMultiplier(ss){ return 0.5+ss*0.5; }

function getVoids(grid){
  const v=[];
  for(let y=0;y<GRID_H;y++)for(let x=0;x<GRID_W;x++){
    if(!grid[y][x]){
      let ab=false;for(let ay=0;ay<y;ay++)if(grid[ay][x]){ab=true;break;}
      if(ab)v.push({x,y});
    }
  }
  return v;
}

function calcCOG(grid){
  let mass=0,wx=0;const seen=new Set();
  for(let y=0;y<GRID_H;y++)for(let x=0;x<GRID_W;x++){
    const c=grid[y][x];
    if(c&&!seen.has(c.id)){seen.add(c.id);mass+=c.box.wc;wx+=c.box.wc*(c.rx+c.w/2);}
  }
  return mass?wx/mass/GRID_W:0.5;
}

function calcScore(){
  const fill=()=>{let n=0;for(let r of state.grid)for(let c of r)if(c)n++;return n;};
  const eff=fill()/(GRID_W*GRID_H);
  const hp=wallH()/GRID_H;
  const el=(Date.now()-startTime)/1000;
  const pph=el>0?Math.round(placedCount/el*3600):0;
  const v=getVoids(state.grid).length;
  const ss=calcSupportScore(state.grid);
  const mult=supportMultiplier(ss);
  // Base score
  let base=Math.round(eff*500+pph*.5+hp*300+(state.sp||0)*8-v*3);
  if(hp>=1)base+=1000;
  // Apply support multiplier, subtract missed parcels penalty
  let s=Math.round(base*mult)-(state.missed||0)*MISS_PENALTY;
  return Math.max(0,s);
}

function wallH(){
  for(let y=0;y<GRID_H;y++)for(let x=0;x<GRID_W;x++)if(state.grid[y][x])return GRID_H-y;
  return 0;
}
function makeGrid(){return Array.from({length:GRID_H},()=>Array(GRID_W).fill(null));}
function fillQ(){while(state.queue.length<MAIN_SZ)state.queue.push(genMain(state.tier));}
function fillS(){while(state.smalls.length<SMALLS_SZ)state.smalls.push(genSmall());}

function place(isSmall,idx,gx,gy,rot){
  const box=isSmall?state.smalls[idx]:state.queue[idx];
  if(!legal(state.grid,box,gx,gy,rot))return false;
  const{w,h}=dims(box,rot);
  const cell={box,id:box.id,rx:gx,ry:gy,w,h,isSmall:box.isSmall};
  for(let dy=0;dy<h;dy++)for(let dx=0;dx<w;dx++)state.grid[gy+dy][gx+dx]=cell;
  if(isSmall){state.smalls.splice(idx,1);state.sp=(state.sp||0)+1;fillS();flashEl('smalls-flash');}
  else{state.queue.splice(idx,1);fillQ();}
  placedCount++;
  state.score=calcScore();
  state.cog=calcCOG(state.grid);
  state.supportScore=calcSupportScore(state.grid);
  checkCOG();checkWin();return true;
}

function flashEl(id){const e=document.getElementById(id);e.classList.add('flash');setTimeout(()=>e.classList.remove('flash'),250);}

function checkCOG(){
  const d=Math.abs(state.cog-.5);
  if(d>.35)flashEl('instability-flash');
  // No game-over from COG alone — just cosmetic warning
}
function checkWin(){
  const p=wallH()/GRID_H;
  if(p>=1)endGame('PERFECT LOAD — 100% HEIGHT ACHIEVED',true);
  else if(p>=WIN_H)endGame('WALL COMPLETE — MISSION ACCOMPLISHED',true);
}

function stashAction(side){
  if(selMain===null)return;
  const stash=side==='left'?state.stL:state.stR;
  if(stash){
    const t=state.queue[selMain];state.queue[selMain]=stash;
    if(side==='left')state.stL=t;else state.stR=t;
  }else{
    const b=state.queue.splice(selMain,1)[0];
    if(side==='left')state.stL=b;else state.stR=b;
    fillQ();selMain=null;
  }
  renderAll();
}

function rotateSelected(){
  if(selMain!==null){const b=state.queue[selMain];if(b.type!=='irregular')selRot=!selRot;}
  else if(selSmalls!==null){const b=state.smalls[selSmalls];if(b.type!=='irregular')selRot=!selRot;}
  renderAll();
}

// ---- CONVEYOR TIMERS — never expire selected pieces ----
function startMainTimer(){
  if(dropTimer)clearInterval(dropTimer);
  const rate=DROP_RATES[state.tier];let el=0;
  dropTimer=setInterval(()=>{
    el+=100;
    // Tick timer only on non-selected slot 0
    if(state.queue.length&&selMain!==0){
      state.queue[0].timerPct=Math.max(0,1-el/rate);
    }
    renderQueueDOM();
    if(el>=rate){
      el=0;
      // Only expire if slot 0 is not selected
      if(state.queue.length&&selMain!==0){
        state.queue.shift();
        state.missed=(state.missed||0)+1;
        state.score=calcScore();
        fillQ();
        // If selected slot shifted, adjust index
        if(selMain!==null&&selMain>0)selMain--;
        else if(selMain===0)selMain=null;
        // Show miss penalty pop in center of screen
        showMissPop();
      } else {
        // Reset timer bar so selected piece doesn't drain
        if(state.queue.length)state.queue[0].timerPct=1;
      }
      checkNoMoves();
    }
  },100);
}

function startSmallsTimer(){
  if(smallsTimer)clearInterval(smallsTimer);
  let el=0;
  smallsTimer=setInterval(()=>{
    el+=100;
    if(state.smalls.length&&selSmalls!==0){
      state.smalls[0].timerPct=Math.max(0,1-el/SMALLS_RATE);
    }
    renderSmallsDOM();
    if(el>=SMALLS_RATE){
      el=0;
      if(state.smalls.length&&selSmalls!==0){
        state.smalls.shift();
        // smalls miss = no penalty (supplemental belt)
        fillS();
        if(selSmalls!==null&&selSmalls>0)selSmalls--;
        else if(selSmalls===0)selSmalls=null;
      }else{
        if(state.smalls.length)state.smalls[0].timerPct=1;
      }
    }
  },100);
}

function showMissPop(){
  const e=document.createElement('div');e.className='score-pop miss';
  e.textContent=`-${MISS_PENALTY} MISSED`;
  e.style.left='50%';e.style.top='40%';e.style.transform='translateX(-50%)';
  document.body.appendChild(e);
  setTimeout(()=>e.remove(),1100);
}

function checkNoMoves(){
  const all=[...state.queue,...state.smalls];
  if(state.stL)all.push(state.stL);if(state.stR)all.push(state.stR);
  if(all.some(b=>anyLegal(state.grid,b)))return;
  endGame('NO VALID PLACEMENTS REMAIN');
}
function checkTierUp(){
  const s=state.score;let t=1;
  if(s>3000)t=4;else if(s>1500)t=3;else if(s>600)t=2;
  if(t>state.tier){state.tier=t;clearInterval(dropTimer);startMainTimer();}
}

// ================================================================
// RENDERING
// ================================================================

function renderTrailer(){
  tCtx.clearRect(0,0,CW,CH);

  // Background grid (outside trailer too)
  tCtx.strokeStyle='rgba(180,130,60,0.08)';tCtx.lineWidth=.5;
  const bgStep=cW;
  for(let x=tL;x<=tL+tW;x+=bgStep){tCtx.beginPath();tCtx.moveTo(x,0);tCtx.lineTo(x,CH);tCtx.stroke();}
  for(let y=tT;y<=tT+tH;y+=cH){tCtx.beginPath();tCtx.moveTo(0,y);tCtx.lineTo(CW,y);tCtx.stroke();}

  // Trailer background
  const g=tCtx.createLinearGradient(tL,tT,tL,tT+tH);
  g.addColorStop(0,'rgba(22,18,12,.96)');g.addColorStop(1,'rgba(10,8,5,.98)');
  tCtx.fillStyle=g;
  tCtx.beginPath();tCtx.roundRect(tL-1,tT-1,tW+2,tH+2,3);tCtx.fill();

  // Trailer grid — brighter inside
  tCtx.strokeStyle='rgba(200,155,70,0.09)';tCtx.lineWidth=.5;
  for(let x=0;x<=GRID_W;x++){
    tCtx.beginPath();tCtx.moveTo(tL+x*cW,tT);tCtx.lineTo(tL+x*cW,tT+tH);tCtx.stroke();
  }
  for(let y=0;y<=GRID_H;y++){
    tCtx.beginPath();tCtx.moveTo(tL,tT+y*cH);tCtx.lineTo(tL+tW,tT+y*cH);tCtx.stroke();
  }

  // Trailer border
  tCtx.strokeStyle='rgba(245,196,0,.3)';tCtx.lineWidth=1.5;
  tCtx.beginPath();tCtx.roundRect(tL-1,tT-1,tW+2,tH+2,3);tCtx.stroke();

  // Floor line
  tCtx.strokeStyle='rgba(180,130,60,0.25)';tCtx.lineWidth=2;
  tCtx.beginPath();tCtx.moveTo(tL,tT+tH-1);tCtx.lineTo(tL+tW,tT+tH-1);tCtx.stroke();

  // 95% line
  const guideY=tT+tH*(1-WIN_H);
  tCtx.save();tCtx.strokeStyle='rgba(0,229,160,.4)';tCtx.lineWidth=1;tCtx.setLineDash([5,4]);
  tCtx.beginPath();tCtx.moveTo(tL,guideY);tCtx.lineTo(tL+tW,guideY);tCtx.stroke();tCtx.setLineDash([]);
  tCtx.fillStyle='rgba(0,229,160,.55)';tCtx.font=`${Math.max(6,cH*.35)}px Share Tech Mono`;
  tCtx.fillText('95%',tL+3,guideY-3);tCtx.restore();

  // Void highlight when smalls selected
  if(selSmalls!==null){
    const voids=getVoids(state.grid);
    const a=.09+.06*Math.sin(Date.now()/300);
    tCtx.fillStyle=`rgba(192,132,252,${a})`;
    for(const{x,y}of voids)tCtx.fillRect(tL+x*cW+1,tT+y*cH+1,cW-2,cH-2);
  }

  // Support quality overlay — faint red on unsupported cells
  if(state.supportScore!==undefined&&state.supportScore<0.85){
    for(let y=0;y<GRID_H;y++){
      for(let x=0;x<GRID_W;x++){
        const c=state.grid[y][x];
        if(!c)continue;
        const belowY=y+1;
        if(belowY<GRID_H&&!state.grid[belowY][x]){
          tCtx.fillStyle='rgba(255,100,30,0.08)';
          tCtx.fillRect(tL+x*cW+1,tT+y*cH+1,cW-2,cH-2);
        }
      }
    }
  }

  // Draw boxes
  const drawn=new Set();
  for(let y=0;y<GRID_H;y++)for(let x=0;x<GRID_W;x++){
    const c=state.grid[y][x];
    if(c&&c.rx===x&&c.ry===y&&!drawn.has(c.id)){drawn.add(c.id);drawBox(c);}
  }
}

// ---- CARDBOARD BOX RENDERER ----
function drawBox(cell){
  const px=tL+cell.rx*cW, py=tT+cell.ry*cH;
  const pw=cell.w*cW, ph=cell.h*cH;
  const p=cell.box.palette;
  const depth=1-(cell.ry/GRID_H)*.03; // subtle perspective
  const sr=seededRand(cell.box.seed||42);

  tCtx.save();
  tCtx.translate(px+pw/2,py+ph/2);tCtx.scale(depth,depth);tCtx.translate(-pw/2,-ph/2);

  // Main cardboard body
  const bg=tCtx.createLinearGradient(0,0,pw,ph);
  bg.addColorStop(0,p.light);
  bg.addColorStop(0.4,p.base);
  bg.addColorStop(1,p.dark);
  tCtx.fillStyle=bg;
  tCtx.fillRect(1,1,pw-2,ph-2);

  // Cardboard texture — subtle horizontal corrugation lines
  tCtx.strokeStyle='rgba(0,0,0,0.07)';tCtx.lineWidth=.5;
  const lineSpacing=Math.max(3,cH*.4);
  for(let ly=lineSpacing;ly<ph-2;ly+=lineSpacing){
    tCtx.beginPath();tCtx.moveTo(2,ly);tCtx.lineTo(pw-2,ly);tCtx.stroke();
  }

  // Box edge shadow (inner bevel)
  tCtx.strokeStyle='rgba(0,0,0,0.3)';tCtx.lineWidth=.5;
  tCtx.strokeRect(1,1,pw-2,ph-2);
  tCtx.strokeStyle='rgba(255,255,255,0.12)';tCtx.lineWidth=.5;
  tCtx.strokeRect(2,2,pw-4,ph-4);

  // TAPE strips — horizontal across top of box (1–2 strips)
  const numTape=cell.w>=3?2:1;
  for(let t=0;t<numTape;t++){
    const tapeX=2+(sr()*pw*.3)*(t===0?0:1);
    const tapeW=Math.min(pw*.5+(sr()*pw*.3), pw-4);
    const tapeH=Math.max(3,cH*.18);
    const tapeY=2+(sr()*Math.min(cH*.4,ph*.25));
    tCtx.fillStyle=p.tape;
    tCtx.fillRect(tapeX,tapeY,tapeW,tapeH);
    // Tape sheen
    tCtx.fillStyle='rgba(255,255,255,0.18)';
    tCtx.fillRect(tapeX,tapeY,tapeW,tapeH*.4);
  }

  // Seam line (center vertical crease)
  if(pw>cW*1.8){
    tCtx.strokeStyle='rgba(0,0,0,0.15)';tCtx.lineWidth=.8;
    const seamX=pw/2+(sr()-.5)*cW*.4;
    tCtx.setLineDash([3,2]);
    tCtx.beginPath();tCtx.moveTo(seamX,2);tCtx.lineTo(seamX,ph-2);tCtx.stroke();
    tCtx.setLineDash([]);
  }

  // Label — small white-ish rectangle with text
  const labelW=Math.max(cW*.8,Math.min(pw*.55,cW*3));
  const labelH=Math.max(cH*.35,Math.min(ph*.4,cH*1.8));
  const labelX=pw*.5-labelW*.5+(sr()-.5)*cW*.3;
  const labelY=ph*.5-labelH*.5+(sr()-.5)*cH*.3;

  if(pw>cW*.7&&ph>cH*.6){
    // Label background
    tCtx.fillStyle=p.label;
    tCtx.beginPath();tCtx.roundRect(labelX,labelY,labelW,labelH,2);tCtx.fill();
    tCtx.strokeStyle='rgba(0,0,0,0.18)';tCtx.lineWidth=.5;tCtx.stroke();

    // Label text
    const fSize=Math.max(4,Math.min(labelH*.38,cH*.28,9));
    tCtx.fillStyle='rgba(40,30,20,0.75)';
    tCtx.font=`bold ${fSize}px Share Tech Mono`;
    tCtx.textAlign='center';tCtx.textBaseline='middle';

    // For fragile: show warning icon instead of label
    if(cell.box.type==='fragile'){
      tCtx.fillStyle='rgba(180,60,20,0.8)';
      tCtx.font=`bold ${Math.max(fSize,5)}px Share Tech Mono`;
      tCtx.fillText('FRAGILE',labelX+labelW*.5,labelY+labelH*.5);
    } else {
      const txt=cell.box.label||cell.box.n||'';
      // Wrap if needed
      if(txt.includes('\n')){
        const parts=txt.split('\n');
        const lineH=fSize*1.2;
        parts.forEach((part,i)=>{
          tCtx.fillText(part,labelX+labelW*.5,labelY+labelH*.5+(i-(parts.length-1)*.5)*lineH);
        });
      }else{
        tCtx.fillText(txt,labelX+labelW*.5,labelY+labelH*.5);
      }
    }

    // Barcode lines (if tall enough)
    if(labelH>cH*.8){
      const bcX=labelX+2,bcY=labelY+labelH*.68,bcW=labelW-4,bcH=labelH*.22;
      for(let bi=0;bi<Math.floor(bcW/2);bi++){
        if(sr()>.4){
          tCtx.fillStyle='rgba(0,0,0,0.6)';
          tCtx.fillRect(bcX+bi*2,bcY,1,bcH);
        }
      }
    }
  }

  // Dense: weight indicator (dark stripes)
  if(cell.box.type==='dense'){
    tCtx.save();tCtx.globalAlpha=0.2;tCtx.fillStyle='#000';
    for(let si=0;si<3;si++){
      const sx=2+si*(pw-4)/3;
      tCtx.fillRect(sx,ph-5,Math.max(3,(pw-4)/4),3);
    }
    tCtx.restore();
  }

  // Smalls: purple tint edge
  if(cell.isSmall){
    tCtx.strokeStyle='rgba(192,132,252,0.4)';tCtx.lineWidth=1;
    tCtx.strokeRect(1,1,pw-2,ph-2);
  }

  tCtx.restore();
}

function renderPlacement(){
  pCtx.clearRect(0,0,CW,CH);
  if(!hoverCell)return;
  const isS=selSmalls!==null;
  const idx=isS?selSmalls:selMain;
  if(idx===null)return;
  const box=isS?state.smalls[idx]:state.queue[idx];
  if(!box)return;
  const{x:gx,y:gy}=hoverCell;
  const ok=legal(state.grid,box,gx,gy,selRot);
  const{w,h}=dims(box,selRot);

  // Show grid cells that would be filled
  pCtx.save();
  if(ok){
    if(isS){pCtx.fillStyle='rgba(192,132,252,.18)';pCtx.strokeStyle='rgba(192,132,252,.85)';}
    else{pCtx.fillStyle='rgba(200,180,100,.15)';pCtx.strokeStyle='rgba(245,196,0,.85)';}
  }else{
    pCtx.fillStyle='rgba(255,77,28,.15)';pCtx.strokeStyle='rgba(255,77,28,.8)';
  }
  pCtx.lineWidth=1.5;
  // Fill each cell slightly inset
  for(let dy=0;dy<h;dy++)for(let dx=0;dx<w;dx++){
    pCtx.fillRect(tL+(gx+dx)*cW+1,tT+(gy+dy)*cH+1,cW-2,cH-2);
  }
  pCtx.strokeRect(tL+gx*cW+.5,tT+gy*cH+.5,w*cW-1,h*cH-1);
  pCtx.fillStyle=ok?'rgba(255,255,255,.8)':'rgba(255,120,80,.9)';
  pCtx.font=`bold ${Math.max(7,cH*.36)}px Share Tech Mono`;
  pCtx.textAlign='center';pCtx.textBaseline='middle';
  pCtx.fillText(`${w}×${h}`,tL+(gx+w/2)*cW,tT+(gy+h/2)*cH);
  pCtx.restore();
}

// ---- QUEUE/SMALLS DOM ----
function mkSlot(box,i,isS){
  const el=document.createElement('div');
  el.className=isS?'smalls-slot':'queue-slot';
  const sel=isS?(selSmalls===i):(selMain===i);
  if(sel)el.classList.add('selected');
  const expiring=(!sel&&i===0&&(box.timerPct||1)<0.25);
  if(expiring)el.classList.add('expiring');
  const r=sel&&selRot;
  const{w,h}=dims(box,r);

  // Mini cardboard box visual
  const vis=document.createElement('canvas');
  const sz=isS?32:42;
  vis.width=sz;vis.height=Math.round(sz*(h/w));
  vis.style.width=sz+'px';vis.style.height=Math.round(sz*(h/w))+'px';
  vis.style.borderRadius='2px';
  drawMiniBox(vis,box,w,h,isS);

  const d=document.createElement('div');d.className='box-dims';
  d.textContent=`${w}×${h}·W${box.wc}`;
  const tb=document.createElement('div');tb.className='timer-bar';
  // Only slot 0 of unselected shows draining timer
  const showDrain=(!sel&&i===0);
  tb.style.width=(showDrain?(box.timerPct||1)*100:100)+'%';
  if(sel)tb.style.display='none'; // hide timer bar on selected piece

  el.appendChild(vis);el.appendChild(d);el.appendChild(tb);
  el.onclick=()=>{if(isS)pickSmall(i);else pickMain(i);};
  return el;
}

function drawMiniBox(canvas,box,w,h,isS){
  const ctx=canvas.getContext('2d');
  const cw=canvas.width,ch=canvas.height;
  const p=box.palette||CARDBOARD_PALETTES[0];
  const bg=ctx.createLinearGradient(0,0,cw,ch);
  bg.addColorStop(0,p.light);bg.addColorStop(1,p.dark);
  ctx.fillStyle=bg;ctx.fillRect(0,0,cw,ch);
  // Corrugation
  ctx.strokeStyle='rgba(0,0,0,0.08)';ctx.lineWidth=.5;
  for(let ly=3;ly<ch;ly+=4){ctx.beginPath();ctx.moveTo(0,ly);ctx.lineTo(cw,ly);ctx.stroke();}
  // Tape
  const tp=p.tape||'rgba(210,190,120,0.7)';
  ctx.fillStyle=tp;ctx.fillRect(2,2,cw-4,Math.max(2,ch*.2));
  ctx.fillStyle='rgba(255,255,255,.15)';ctx.fillRect(2,2,cw-4,Math.max(1,ch*.08));
  // Border
  ctx.strokeStyle='rgba(0,0,0,0.3)';ctx.lineWidth=.5;ctx.strokeRect(.5,.5,cw-1,ch-1);
  if(isS){ctx.strokeStyle='rgba(192,132,252,0.4)';ctx.lineWidth=1;ctx.strokeRect(.5,.5,cw-1,ch-1);}
  // Label text if big enough
  if(cw>18&&ch>12){
    ctx.fillStyle='rgba(40,25,10,0.6)';
    ctx.font=`bold ${Math.max(5,Math.min(ch*.3,7))}px Share Tech Mono`;
    ctx.textAlign='center';ctx.textBaseline='middle';
    const txt=box.n||(box.type==='fragile'?'▲':box.type==='dense'?'■':'');
    ctx.fillText(txt,cw/2,ch*.62);
  }
}

function renderQueueDOM(){
  const row=document.getElementById('queue-row');row.innerHTML='';
  for(let i=0;i<state.queue.length;i++)row.appendChild(mkSlot(state.queue[i],i,false));
  document.getElementById('missed-badge').textContent=`MISSED: ${state.missed||0}`;
}
function renderSmallsDOM(){
  const row=document.getElementById('smalls-row');row.innerHTML='';
  for(let i=0;i<state.smalls.length;i++)row.appendChild(mkSlot(state.smalls[i],i,true));
  const v=getVoids(state.grid).length;
  const bd=document.getElementById('void-badge');
  if(v>0){bd.classList.add('visible');bd.textContent=`⬛ ${v} VOID${v>1?'S':''} — USE SMALLS`;}
  else bd.classList.remove('visible');
}
function renderStash(){
  for(const side of['left','right']){
    const el=document.getElementById('stash-'+side);
    const box=side==='left'?state.stL:state.stR;
    el.innerHTML='';
    if(box){
      el.classList.add('has-box');
      const p=box.palette||CARDBOARD_PALETTES[0];
      const v=document.createElement('div');
      v.style.cssText=`width:26px;height:18px;background:${p.base};border-radius:2px;font-size:5px;color:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;font-family:'Share Tech Mono',monospace;border:1px solid rgba(0,0,0,0.2);`;
      v.textContent=`${box.w}×${box.h}`;
      const l=document.createElement('div');l.className='stash-label';l.textContent='STASH '+(side==='left'?'L':'R');
      el.appendChild(v);el.appendChild(l);
    }else{
      el.classList.remove('has-box');
      el.innerHTML=`<span>STASH ${side==='left'?'L':'R'}</span><span class="stash-label">EMPTY</span>`;
    }
  }
}
function renderHUD(){
  const h=wallH(),p=h/GRID_H;
  document.getElementById('height-fill').style.width=(p*100)+'%';
  document.getElementById('height-pct').textContent=Math.round(p*100)+'%';
  document.getElementById('score-val').textContent=state.score;
  const el=(Date.now()-startTime)/1000;
  const pph=el>0?Math.round(placedCount/el*3600):0;
  document.getElementById('pph-val').textContent=pph||'—';
  document.getElementById('tier-val').textContent='T'+state.tier;
  // Support score
  const ss=state.supportScore||1;
  const ssP=Math.round(ss*100);
  document.getElementById('support-fill').style.width=ssP+'%';
  document.getElementById('support-pct').textContent=ssP+'%';
  document.getElementById('support-val').textContent=ssP+'%';
  // COG
  const d=Math.abs(state.cog-.5);
  document.getElementById('cog-marker').style.left=(state.cog*100)+'%';
  const cs=document.getElementById('cog-status');
  if(d<.1){cs.textContent='STABLE';cs.style.color='var(--ok)';}
  else if(d<.25){cs.textContent='CAUTION';cs.style.color='var(--warn)';}
  else if(d<.35){cs.textContent='WARN';cs.style.color='var(--accent2)';}
  else{cs.textContent='DANGER';cs.style.color='var(--danger)';}
}
function renderAll(){renderQueueDOM();renderSmallsDOM();renderStash();renderPlacement();}
function loop(){renderTrailer();renderHUD();checkTierUp();animFrame=requestAnimationFrame(loop);}

function pickMain(i){
  selSmalls=null;
  if(selMain===i){selMain=null;selRot=false;}else{selMain=i;selRot=false;}
  renderAll();
}
function pickSmall(i){
  selMain=null;
  if(selSmalls===i){selSmalls=null;selRot=false;}else{selSmalls=i;selRot=false;}
  renderAll();
}

// ---- POINTER EVENTS ----
function getPointerCoords(e){
  const r=tC.getBoundingClientRect();
  const clientX=e.clientX??e.touches?.[0]?.clientX??e.changedTouches?.[0]?.clientX;
  const clientY=e.clientY??e.touches?.[0]?.clientY??e.changedTouches?.[0]?.clientY;
  if(clientX===undefined||clientY===undefined)return null;
  return{mx:(clientX-r.left)*(CW/r.width),my:(clientY-r.top)*(CH/r.height)};
}
tC.addEventListener('pointermove',e=>{
  if(e.pointerType==='touch')e.preventDefault();
  const c=getPointerCoords(e);if(c)hover(c.mx,c.my);
},{passive:false});
tC.addEventListener('pointerdown',e=>{e.preventDefault();},{passive:false});
tC.addEventListener('pointerup',e=>{
  e.preventDefault();
  const c=getPointerCoords(e);if(c)doPlace(c.mx,c.my);
},{passive:false});
tC.addEventListener('contextmenu',e=>e.preventDefault());

function hover(mx,my){
  const gx=Math.floor((mx-tL)/cW),gy=Math.floor((my-tT)/cH);
  hoverCell=(gx>=0&&gx<GRID_W&&gy>=0&&gy<GRID_H)?{x:gx,y:gy}:null;
  renderPlacement();
}
function doPlace(mx,my){
  const isS=selSmalls!==null;
  const idx=isS?selSmalls:selMain;
  if(idx===null)return;
  const gx=Math.floor((mx-tL)/cW),gy=Math.floor((my-tT)/cH);
  if(gx<0||gx>=GRID_W||gy<0||gy>=GRID_H)return;
  const box=isS?state.smalls[idx]:state.queue[idx];
  if(!box||!legal(state.grid,box,gx,gy,selRot))return;
  const prev=state.score;
  place(isS,idx,gx,gy,selRot);
  const delta=state.score-prev;
  showPop(mx,my,(delta>=0?'+':'')+delta,isS?'smalls':'main');
  if(isS)selSmalls=null;else selMain=null;
  selRot=false;
  renderAll();
}
function showPop(x,y,t,type){
  const e=document.createElement('div');e.className=`score-pop ${type}`;e.textContent=t;
  e.style.left=x+'px';e.style.top=y+'px';document.body.appendChild(e);
  setTimeout(()=>e.remove(),1000);
}

// ---- LIFECYCLE ----
function setDiff(d,btn){
  initDiff=d;
  document.querySelectorAll('.diff-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function startGame(){
  document.getElementById('start-overlay').classList.add('hidden');
  state={grid:makeGrid(),queue:[],smalls:[],stL:null,stR:null,
    score:0,tier:initDiff,cog:.5,sp:0,missed:0,supportScore:1};
  fillQ();fillS();
  placedCount=0;startTime=Date.now();selMain=null;selSmalls=null;selRot=false;hoverCell=null;
  resize();renderAll();
  startMainTimer();startSmallsTimer();
  if(animFrame)cancelAnimationFrame(animFrame);
  loop();
}
function restartGame(){document.getElementById('gameover-overlay').classList.add('hidden');startGame();}

function endGame(reason,win=false){
  if(animFrame)cancelAnimationFrame(animFrame);
  if(dropTimer)clearInterval(dropTimer);
  if(smallsTimer)clearInterval(smallsTimer);
  const h=wallH(),hp=h/GRID_H;
  const fill=()=>{let n=0;for(let r of state.grid)for(let c of r)if(c)n++;return n;};
  const eff=fill()/(GRID_W*GRID_H);
  const el=(Date.now()-startTime)/1000;
  const pph=el>0?Math.round(placedCount/el*3600):0;
  const ss=state.supportScore||1;

  renderHeatmap();
  hC.classList.add('visible');setTimeout(()=>hC.classList.remove('visible'),2500);
  document.getElementById('go-title').innerHTML=win?(hp>=1?'PERFECT<br>LOAD':'WALL<br>COMPLETE'):'GAME<br>OVER';
  document.getElementById('go-sub').textContent=reason;
  document.getElementById('go-score').textContent=state.score;
  document.getElementById('go-pph').textContent=pph;
  document.getElementById('go-eff').textContent=Math.round(eff*100)+'%';
  document.getElementById('go-support').textContent=Math.round(ss*100)+'%';
  document.getElementById('tip-text').textContent=tipMsg(eff,state.cog,getVoids(state.grid).length,state.sp||0,ss,state.missed||0);
  document.getElementById('gameover-overlay').classList.remove('hidden');
}
function tipMsg(eff,c,v,sp,ss,missed){
  const t=[];
  if(missed>3)t.push(`${missed} parcels missed the belt! Select pieces before the timer drains to freeze them.`);
  if(ss<0.6)t.push(`Support score was ${Math.round(ss*100)}% — place boxes on solid footing for the score multiplier.`);
  if(Math.abs(c-.5)>.2)t.push('COG was off-center — balance heavy pieces side-to-side for best load quality.');
  if(v>5)t.push(`${v} buried voids found. Use the SMALLS belt to plug gaps before they get covered!`);
  if(sp===0)t.push('Never used the SMALLS belt — small pieces fill gaps for big efficiency bonuses.');
  if(!t.length)t.push('Outstanding load! Keep pushing support score and smalls usage for elite scores.');
  return'💡 '+t[0];
}

function renderHeatmap(){
  hCtx.clearRect(0,0,CW,CH);
  for(let y=0;y<GRID_H;y++)for(let x=0;x<GRID_W;x++){
    const c=state.grid[y][x];
    const px=tL+x*cW,py=tT+y*cH;
    if(c){const e=c.box.wc/5;hCtx.fillStyle=c.isSmall?`rgba(192,132,252,${e*.8})`:`rgba(0,229,160,${e*.7})`;}
    else{let ab=false;for(let ay=0;ay<y;ay++)if(state.grid[ay][x]){ab=true;break;}hCtx.fillStyle=ab?'rgba(255,77,28,.6)':'transparent';}
    hCtx.fillRect(px,py,cW-1,cH-1);
  }
}

window.addEventListener('resize',resize);
resize();
</script>
</body>
</html>
